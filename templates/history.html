<!DOCTYPE html>
<html lang="zh-CN">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>è®¾è®¡å†å² - å§å”§ç”Ÿæˆå™¨</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>
    <script src="/static/js/device-manager.js"></script>
    <link rel="stylesheet" href="/static/css/design.css">
    <style>
        .history-card {
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }

        .history-card:hover {
            transform: translateY(-8px) scale(1.02);
            box-shadow: 0 20px 25px rgba(0, 0, 0, 0.1);
        }

        .history-image {
            transition: transform 0.5s ease;
        }

        .history-card:hover .history-image {
            transform: scale(1.1);
        }

        .filter-tab {
            transition: all 0.2s ease;
        }

        .filter-tab.active {
            background: linear-gradient(135deg, #3b82f6 0%, #1d4ed8 100%);
            color: white;
            transform: scale(1.05);
        }

        .loading-spinner {
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            from {
                transform: rotate(0deg);
            }
            to {
                transform: rotate(360deg);
            }
        }

        /* å¯¼èˆªæ æ ·å¼ */
        .navbar {
            position: sticky;
            top: 0;
            z-index: 50;
        }

        .nav-link {
            position: relative;
            padding: 0.5rem 0;
            font-weight: 500;
        }

        .nav-link:hover {
            transform: translateY(-1px);
        }

        .mobile-menu {
            animation: slideDown 0.3s ease-out;
        }

        @keyframes slideDown {
            from {
                opacity: 0;
                transform: translateY(-10px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .empty-state {
            background: linear-gradient(135deg, #f8fafc 0%, #e2e8f0 100%);
        }

        .status-badge {
            font-size: 0.75rem;
            padding: 0.25rem 0.75rem;
            border-radius: 9999px;
            font-weight: 500;
        }

        .status-pending {
            background-color: #fef3c7;
            color: #92400e;
        }

        .status-processing {
            background-color: #dbeafe;
            color: #1e40af;
        }

        .status-completed {
            background-color: #d1fae5;
            color: #065f46;
        }

        .status-cancelled {
            background-color: #fee2e2;
            color: #991b1b;
        }
        
        /* å¯¼èˆªç»„ä»¶æ ·å¼ */
        .user-menu-dropdown {
            transition: all 0.2s ease-out;
            transform-origin: top right;
        }
        
        .menu-open {
            opacity: 1;
            transform: translateY(0) scale(1);
            visibility: visible;
        }
        
        .menu-closed {
            opacity: 0;
            transform: translateY(-10px) scale(0.95);
            visibility: hidden;
        }
        
        .user-menu-btn {
            transition: all 0.2s ease-out;
        }
        
        .user-menu-btn:hover {
            transform: translateY(-1px);
        }
        
        .user-menu-dropdown a,
        .user-menu-dropdown button {
            transition: all 0.15s ease-out;
        }
        
        .user-menu-dropdown a:hover,
        .user-menu-dropdown button:hover {
            transform: translateX(2px);
            background-color: rgba(59, 130, 246, 0.05);
        }
    </style>
</head>

<body class="bg-gray-50">
    <div id="app">
        <!-- ç»Ÿä¸€å¯¼èˆªæ  -->
        <nav class="navbar bg-white shadow-sm border-b border-gray-200">
            <div class="container mx-auto px-4">
                <div class="flex items-center justify-between h-16">
                    <!-- Logoå’Œæ ‡é¢˜ -->
                    <div class="flex items-center space-x-4">
                        <a href="/" class="flex items-center space-x-2 text-blue-600 hover:text-blue-700 transition-colors">
                            <svg class="w-8 h-8" fill="currentColor" viewBox="0 0 24 24">
                                <path d="M12 2L2 7l10 5 10-5-10-5zM2 17l10 5 10-5M2 12l10 5 10-5"/>
                            </svg>
                            <span class="text-xl font-bold">å§å”§ç”Ÿæˆå™¨</span>
                        </a>
                    </div>

                    <!-- å¯¼èˆªèœå• -->
                    <div class="hidden md:flex items-center space-x-6">
                        <a href="/" class="nav-link text-gray-600 hover:text-blue-600 transition-colors">
                            é¦–é¡µ
                        </a>
                        <a href="/gallery" class="nav-link text-gray-600 hover:text-blue-600 transition-colors">
                            ä½œå“ç”»å»Š
                        </a>
                        <a href="/design" class="nav-link text-gray-600 hover:text-blue-600 transition-colors">
                            å¼€å§‹è®¾è®¡
                        </a>
                        <a href="/history" class="nav-link text-gray-600 hover:text-blue-600 transition-colors">
                            åˆ¶ä½œå†å²
                        </a>
                        <a href="/orders" class="nav-link text-gray-600 hover:text-blue-600 transition-colors">
                            æˆ‘çš„è®¢å•
                        </a>
                    </div>

                    <!-- ç”¨æˆ·èœå• -->
                    <div class="flex items-center space-x-2">
                        <div class="relative">
                            <button @click="toggleUserMenu" class="user-menu-btn flex items-center space-x-2 p-2 rounded-lg text-gray-600 hover:text-blue-600 hover:bg-gray-100 transition-colors">
                                <div class="w-8 h-8 bg-blue-100 rounded-full flex items-center justify-center">
                                    <svg class="w-5 h-5 text-blue-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z"></path>
                                    </svg>
                                </div>
                                <span class="hidden md:block text-sm font-medium">æˆ‘çš„è´¦æˆ·</span>
                                <svg class="w-4 h-4 transition-transform" :class="{ 'rotate-180': userMenuOpen }" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path>
                                </svg>
                            </button>

                            <!-- ç”¨æˆ·èœå•ä¸‹æ‹‰ -->
                            <div v-show="userMenuOpen" class="user-menu-dropdown absolute right-0 mt-2 w-64 bg-white rounded-lg shadow-lg border border-gray-200 py-2 z-50" :class="{ 'menu-open': userMenuOpen, 'menu-closed': !userMenuOpen }">
                                <!-- ç”¨æˆ·ä¿¡æ¯ -->
                                <div class="px-4 py-3 border-b border-gray-100">
                                    <div class="flex items-center space-x-3">
                                        <div class="w-10 h-10 bg-blue-100 rounded-full flex items-center justify-center">
                                            <svg class="w-6 h-6 text-blue-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z"></path>
                                            </svg>
                                        </div>
                                        <div>
                                            <p class="text-sm font-medium text-gray-900">è®¿å®¢ç”¨æˆ·</p>
                                            <p class="text-xs text-gray-500">åŸºäºè®¢å•å·çš„èº«ä»½ç®¡ç†</p>
                                        </div>
                                    </div>
                                </div>

                                <!-- å¿«é€Ÿæ“ä½œ -->
                                <div class="px-2 py-2">
                                    <a href="/" class="flex items-center px-2 py-2 text-sm text-gray-700 hover:bg-gray-100 rounded-md">
                                        <svg class="w-4 h-4 mr-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 7v10a2 2 0 002 2h14a2 2 0 002-2V9a2 2 0 00-2-2H5a2 2 0 00-2-2z"></path>
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 5a2 2 0 012-2h4a2 2 0 012 2v2H8V5z"></path>
                                        </svg>
                                        é¦–é¡µ
                                    </a>
                                    <a href="/gallery" class="flex items-center px-2 py-2 text-sm text-gray-700 hover:bg-gray-100 rounded-md">
                                        <svg class="w-4 h-4 mr-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16l4.586-4.586a2 2 0 012.828 0L16 16m-2-2l1.586-1.586a2 2 0 012.828 0L20 14m-6-6h.01M6 20h12a2 2 0 002-2V6a2 2 0 00-2-2H6a2 2 0 00-2 2v12a2 2 0 002 2z"></path>
                                        </svg>
                                        ä½œå“ç”»å»Š
                                    </a>
                                    <a href="/design" class="flex items-center px-2 py-2 text-sm text-gray-700 hover:bg-gray-100 rounded-md">
                                        <svg class="w-4 h-4 mr-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6v6m0 0v6m0-6h6m-6 0H6"></path>
                                        </svg>
                                        å¼€å§‹è®¾è®¡
                                    </a>
                                    <a href="/orders" class="flex items-center px-2 py-2 text-sm text-gray-700 hover:bg-gray-100 rounded-md">
                                        <svg class="w-4 h-4 mr-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5H7a2 2 0 00-2 2v10a2 2 0 002 2h8a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2"></path>
                                        </svg>
                                        æˆ‘çš„è®¢å•
                                    </a>
                                    <a href="/history" class="flex items-center px-2 py-2 text-sm text-gray-700 hover:bg-gray-100 rounded-md">
                                        <svg class="w-4 h-4 mr-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                                        </svg>
                                        è®¾è®¡å†å²
                                    </a>
                                    <a href="/delivery" class="flex items-center px-2 py-2 text-sm text-gray-700 hover:bg-gray-100 rounded-md">
                                        <svg class="w-4 h-4 mr-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M20 7l-8-4-8 4m16 0l-8 4m8-4v10l-8 4m0-10L4 7m8 4v10M4 7v10l8 4"></path>
                                        </svg>
                                        é…é€ç®¡ç†
                                    </a>
                                </div>
  
                                <!-- åˆ†éš”çº¿ -->
                                <div class="border-t border-gray-100 my-2"></div>

                                <!-- å¸®åŠ©å’Œå…³äº -->
                                <div class="px-2 py-2">
                                    <button @click="showHelp" class="flex items-center w-full px-2 py-2 text-sm text-gray-700 hover:bg-gray-100 rounded-md">
                                        <svg class="w-4 h-4 mr-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8.228 9c.549-1.165 2.03-2 3.772-2 2.21 0 4 1.343 4 3 0 1.4-1.278 2.575-3.006 2.907-.542.104-.994.54-.994 1.093m0 3h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                                        </svg>
                                        å¸®åŠ©ä¸­å¿ƒ
                                    </button>
                                    <!-- <button @click="resetUserData" class="flex items-center w-full px-2 py-2 text-sm text-red-600 hover:bg-red-50 rounded-md">
                                        <svg class="w-4 h-4 mr-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"></path>
                                        </svg>
                                        é‡ç½®æ•°æ®
                                    </button> -->
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </nav>

        <!-- ä¸»è¦å†…å®¹ -->
        <main class="container mx-auto px-4 py-8">
            <!-- é¡µé¢æ ‡é¢˜ -->
            <div class="mb-8">
                <h1 class="text-3xl font-bold text-gray-900 mb-2">æˆ‘çš„è®¾è®¡å†å²</h1>
                <p class="text-gray-600">æŸ¥çœ‹æ‚¨æ›¾ç»è®¾è®¡çš„æ‰€æœ‰å§å”§ä½œå“ï¼ŒåŒ…æ‹¬å·²å®Œæˆè®¾è®¡å’Œå·²æäº¤çš„è®¢å•</p>
            </div>

            <!-- ç­›é€‰å’Œæœç´¢ -->
            <div class="mb-6">
                <div class="flex flex-col sm:flex-row sm:items-center sm:justify-between gap-4">
                    <!-- çŠ¶æ€ç­›é€‰ -->
                    <div class="flex flex-wrap gap-2">
                        <button 
                            @click="setFilter('all')" 
                            :class="['filter-tab px-4 py-2 rounded-full text-sm font-medium', 
                                   currentFilter === 'all' ? 'active' : 'bg-gray-100 text-gray-600 hover:bg-gray-200']">
                            å…¨éƒ¨ ({{ getTotalCount() }})
                        </button>
                        <button 
                            @click="setFilter('completed')" 
                            :class="['filter-tab px-4 py-2 rounded-full text-sm font-medium', 
                                   currentFilter === 'completed' ? 'active' : 'bg-gray-100 text-gray-600 hover:bg-gray-200']">
                            è®¾è®¡å®Œæˆ ({{ getCountByStatus('completed') }})
                        </button>
                        <button 
                            @click="setFilter('processing')" 
                            :class="['filter-tab px-4 py-2 rounded-full text-sm font-medium', 
                                   currentFilter === 'processing' ? 'active' : 'bg-gray-100 text-gray-600 hover:bg-gray-200']">
                            å·²ä¸‹å• ({{ getCountByStatus('processing') }})
                        </button>
                        <button 
                            @click="setFilter('pending')" 
                            :class="['filter-tab px-4 py-2 rounded-full text-sm font-medium', 
                                   currentFilter === 'pending' ? 'active' : 'bg-gray-100 text-gray-600 hover:bg-gray-200']">
                            å¾…æ”¯ä»˜ ({{ getCountByStatus('pending') }})
                        </button>
                    </div>

                    <!-- æœç´¢æ¡† -->
                    <div class="relative">
                        <input 
                            v-model="searchTerm" 
                            @input="onSearchInput"
                            type="text" 
                            placeholder="æœç´¢è®¢å•å·..." 
                            class="pl-10 pr-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                        <svg class="absolute left-3 top-2.5 w-5 h-5 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"></path>
                        </svg>
                    </div>
                </div>
            </div>

            <!-- åŠ è½½çŠ¶æ€ -->
            <div v-if="loading" class="flex justify-center items-center py-12">
                <div class="loading-spinner w-8 h-8 border-4 border-blue-200 border-t-blue-600 rounded-full"></div>
                <span class="ml-3 text-gray-600">åŠ è½½ä¸­...</span>
            </div>

            <!-- å†å²è®°å½•åˆ—è¡¨ -->
            <div v-else-if="filteredHistory.length > 0" class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-6">
                <div 
                    v-for="item in paginatedHistory" 
                    :key="item.orderNo" 
                    class="history-card bg-white rounded-xl shadow-sm border border-gray-200 overflow-hidden">
                    
                    <!-- å›¾ç‰‡ -->
                    <div class="relative h-48 overflow-hidden">
                        <img 
                            :src="getImageUrl(item.imagePath)" 
                            :alt="`è®¢å• ${item.orderNo}`"
                            class="history-image w-full h-full object-cover"
                            @error="handleImageError">
                        
                        <!-- çŠ¶æ€æ ‡ç­¾ -->
                        <div class="absolute top-3 right-3">
                            <span :class="['status-badge', `status-${item.status}`]">
                                {{ getDesignStatusText(item.status) }}
                            </span>
                        </div>

                        <!-- æ‚¬åœæ“ä½œ -->
                        <div class="absolute inset-0 bg-black bg-opacity-0 hover:bg-opacity-30 transition-all duration-300 flex items-center justify-center opacity-0 hover:opacity-100">
                            <div class="flex space-x-2">
                                <button 
                                    v-if="item.paymentStatus === 'paid'"
                                    @click="viewOrder(item.orderNo)"
                                    class="px-4 py-2 bg-white text-gray-800 rounded-lg font-medium hover:bg-gray-100 transition-colors">
                                    æŸ¥çœ‹è¯¦æƒ…
                                </button>
                                <button 
                                    v-if="item.status === 'pending' || (item.status === 'processing' && item.paymentStatus === 'unpaid')"
                                    @click="payOrder(item.orderNo)"
                                    class="px-4 py-2 bg-blue-600 text-white rounded-lg font-medium hover:bg-blue-700 transition-colors">
                                    ç«‹å³æ”¯ä»˜
                                </button>
                                <button 
                                    v-if="item.status === 'completed'"
                                    @click="downloadOrder(item.orderNo)"
                                    class="px-4 py-2 bg-green-600 text-white rounded-lg font-medium hover:bg-green-700 transition-colors">
                                    ä¸‹è½½
                                </button>
                            </div>
                        </div>
                    </div>

                    <!-- ä¿¡æ¯ -->
                    <div class="p-4">
                        <h3 class="font-semibold text-gray-900 mb-1">è®¢å• {{ item.orderNo }}</h3>
                        <p class="text-sm text-gray-600 mb-2">{{ formatDate(item.createdAt) }}</p>
                        <p class="text-sm text-gray-500">ä»·æ ¼: Â¥{{ item.totalPrice }}</p>
                    </div>
                </div>
            </div>

            <!-- ç©ºçŠ¶æ€ -->
            <div v-else class="empty-state rounded-xl p-12 text-center">
                <svg class="w-16 h-16 text-gray-400 mx-auto mb-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path>
                </svg>
                <h3 class="text-lg font-medium text-gray-900 mb-2">æš‚æ— è®¾è®¡å†å²</h3>
                <p class="text-gray-600 mb-4">æ‚¨è¿˜æ²¡æœ‰åˆ¶ä½œè¿‡ä»»ä½•å§å”§ä½œå“</p>
                <a href="/design" class="inline-flex items-center px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition-colors">
                    <svg class="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6v6m0 0v6m0-6h6m-6 0H6"></path>
                    </svg>
                    å¼€å§‹åˆ¶ä½œ
                </a>
            </div>

            <!-- åˆ†é¡µ -->
            <div v-if="totalPages > 1" class="mt-8 flex justify-center">
                <nav class="flex items-center space-x-2">
                    <button 
                        @click="goToPage(currentPage - 1)"
                        :disabled="currentPage === 1"
                        class="px-3 py-2 text-sm font-medium text-gray-500 bg-white border border-gray-300 rounded-md hover:bg-gray-50 disabled:opacity-50 disabled:cursor-not-allowed">
                        ä¸Šä¸€é¡µ
                    </button>
                    
                    <template v-for="page in visiblePages" :key="page">
                        <button 
                            @click="goToPage(page)"
                            :class="['px-3 py-2 text-sm font-medium rounded-md', 
                                   page === currentPage ? 'bg-blue-600 text-white' : 'text-gray-500 bg-white border border-gray-300 hover:bg-gray-50']">
                            {{ page }}
                        </button>
                    </template>
                    
                    <button 
                        @click="goToPage(currentPage + 1)"
                        :disabled="currentPage === totalPages"
                        class="px-3 py-2 text-sm font-medium text-gray-500 bg-white border border-gray-300 rounded-md hover:bg-gray-50 disabled:opacity-50 disabled:cursor-not-allowed">
                        ä¸‹ä¸€é¡µ
                    </button>
                </nav>
            </div>
        </main>

        <!-- é¡µè„š -->
        <footer class="bg-white border-t border-gray-200 mt-16">
            <div class="container mx-auto px-4 py-8">
                <div class="text-center text-gray-600">
                    <p>&copy; 2024 å§å”§ç”Ÿæˆå™¨. All rights reserved.</p>
                </div>
            </div>
        </footer>
    </div>

    <script src="/static/js/user-state-manager.js"></script>
    <script src="/static/js/navigation.js"></script>
    <script>
        const { createApp, ref, computed, onMounted } = Vue;

        createApp({
            setup() {
                // å¯¼èˆªç»„ä»¶æ•°æ®
                const userMenuOpen = ref(false);
                const navigationHTML = ref('');
                
                const loading = ref(true);
                const historyData = ref([]);
                const currentFilter = ref('all');
                const searchTerm = ref('');
                const currentPage = ref(1);
                const pageSize = ref(12);
                const userStateManager = window.UserStateManager;

                // è®¡ç®—å±æ€§
                const filteredHistory = computed(() => {
                    let filtered = historyData.value;

                    // çŠ¶æ€ç­›é€‰
                    if (currentFilter.value !== 'all') {
                        filtered = filtered.filter(item => item.status === currentFilter.value);
                    }

                    // æœç´¢ç­›é€‰
                    if (searchTerm.value.trim()) {
                        const term = searchTerm.value.toLowerCase();
                        filtered = filtered.filter(item => 
                            item.orderNo.toLowerCase().includes(term)
                        );
                    }

                    return filtered.sort((a, b) => new Date(b.createdAt) - new Date(a.createdAt));
                });

                const totalPages = computed(() => Math.ceil(filteredHistory.value.length / pageSize.value));

                const paginatedHistory = computed(() => {
                    const start = (currentPage.value - 1) * pageSize.value;
                    const end = start + pageSize.value;
                    return filteredHistory.value.slice(start, end);
                });

                const visiblePages = computed(() => {
                    const pages = [];
                    const start = Math.max(1, currentPage.value - 2);
                    const end = Math.min(totalPages.value, start + 4);
                    
                    for (let i = start; i <= end; i++) {
                        pages.push(i);
                    }
                    return pages;
                });

                // æ–¹æ³•
                const loadHistory = () => {
                    try {
                        loading.value = true;
                        
                        // ä»localStorageåŠ è½½å†å²æ•°æ®
                        const orderHistory = userStateManager.getOrderHistory();
                        const recentOrders = userStateManager.getRecentOrders();
                        
                        // åˆå¹¶æ•°æ®å¹¶å»é‡
                        const allOrders = [...orderHistory, ...recentOrders];
                        const uniqueOrders = allOrders.filter((order, index, self) => 
                            index === self.findIndex(o => o.orderNo === order.orderNo)
                        );
                        
                        historyData.value = uniqueOrders;
                        console.log('ğŸ“š åŠ è½½è®¾è®¡å†å²:', historyData.value.length, 'æ¡è®°å½•');
                        
                    } catch (error) {
                        console.error('åŠ è½½å†å²æ•°æ®å¤±è´¥:', error);
                        historyData.value = [];
                    } finally {
                        loading.value = false;
                    }
                };

                const setFilter = (filter) => {
                    currentFilter.value = filter;
                    currentPage.value = 1;
                };

                const onSearchInput = () => {
                    currentPage.value = 1;
                };

                const goToPage = (page) => {
                    if (page >= 1 && page <= totalPages.value) {
                        currentPage.value = page;
                        window.scrollTo({ top: 0, behavior: 'smooth' });
                    }
                };

                const getTotalCount = () => historyData.value.length;

                const getCountByStatus = (status) => {
                    return historyData.value.filter(item => item.status === status).length;
                };

                const getImageUrl = (imagePath) => {
                    if (!imagePath) return '/static/images/placeholder.png';
                    
                    // å¤„ç†ç›¸å¯¹è·¯å¾„
                    if (imagePath.startsWith('static/')) {
                        return '/' + imagePath;
                    }
                    
                    // å¤„ç†ç»å¯¹è·¯å¾„
                    if (imagePath.startsWith('/')) {
                        return imagePath;
                    }
                    
                    return '/static/uploads/' + imagePath;
                };

                const handleImageError = (event) => {
                    event.target.src = '/static/images/placeholder.png';
                };

                const getStatusText = (status) => {
                    const statusMap = {
                        'pending': 'å¾…æ”¯ä»˜',
                        'processing': 'å¤„ç†ä¸­',
                        'completed': 'å·²å®Œæˆ',
                        'cancelled': 'å·²å–æ¶ˆ'
                    };
                    return statusMap[status] || status;
                };

                const getDesignStatusText = (status) => {
                    const statusMap = {
                        'pending': 'å¾…æ”¯ä»˜',
                        'processing': 'å·²ä¸‹å•',
                        'completed': 'è®¾è®¡å®Œæˆ',
                        'cancelled': 'å·²å–æ¶ˆ'
                    };
                    return statusMap[status] || status;
                };

                const formatDate = (dateString) => {
                    const date = new Date(dateString);
                    return date.toLocaleDateString('zh-CN', {
                        year: 'numeric',
                        month: '2-digit',
                        day: '2-digit',
                        hour: '2-digit',
                        minute: '2-digit'
                    });
                };

                const viewOrder = (orderNo) => {
                    // åªæœ‰å·²æ”¯ä»˜çš„è®¢å•æ‰ä¼šè°ƒç”¨æ­¤å‡½æ•°ï¼Œç›´æ¥è·³è½¬åˆ°è®¢å•è¯¦æƒ…é¡µé¢
                    window.location.href = `/order/${orderNo}`;
                };

                const payOrder = (orderNo) => {
                    // è·³è½¬åˆ°æ”¯ä»˜é¡µé¢
                    window.location.href = `/payment?order_no=${orderNo}`;
                };

                const downloadOrder = (orderNo) => {
                    window.open(`/download/${orderNo}`, '_blank');
                };

                // ç”Ÿå‘½å‘¨æœŸ
                // å¯¼èˆªç»„ä»¶æ–¹æ³•
                const toggleUserMenu = () => {
                    userMenuOpen.value = !userMenuOpen.value;
                };  
                const showHelp = () => {
                    userMenuOpen.value = false;
                    alert('å¸®åŠ©ä¸­å¿ƒåŠŸèƒ½å¼€å‘ä¸­...');
                };
                const resetUserData = () => {
                    userMenuOpen.value = false;
                    if (window.UserStateManager) {
                        window.UserStateManager.resetAllData();
                    }
                };

                onMounted(() => {
                    loadHistory();
                });

                return {
                    userMenuOpen,
                    loading,
                    historyData,
                    currentFilter,
                    searchTerm,
                    currentPage,
                    pageSize,
                    filteredHistory,
                    totalPages,
                    paginatedHistory,
                    visiblePages,
                    setFilter,
                    onSearchInput,
                    goToPage,
                    getTotalCount,
                    getCountByStatus,
                    getImageUrl,
                    handleImageError,
                    getStatusText,
                    getDesignStatusText,
                    formatDate,
                    viewOrder,
                    payOrder,
                    downloadOrder,
                    toggleUserMenu,  
                    showHelp, 
                };
            }
        }).mount('#app');
    </script>
</body>

</html>
