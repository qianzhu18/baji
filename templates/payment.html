<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ÊîØ‰ªòÈ°µÈù¢ - ÂêßÂîßÁîüÊàêÂô®</title>
    <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="[[ url_for('static', filename='js/device-manager.js') ]]"></script>
    <script src="[[ url_for('static', filename='js/magic-experience.js')  ]]"></script>
    <script src="[[ url_for('static', filename='js/user-state-manager.js') ]]"></script>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: linear-gradient(135deg, #f8fafc 0%, #e2e8f0 100%);
        }
        .payment-card {
            background: white;
            border-radius: 1rem;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.1);
            animation: slideInUp 0.6s ease-out;
        }
        @keyframes slideInUp {
            from {
                opacity: 0;
                transform: translateY(30px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }
        .magic-button {
            background: linear-gradient(135deg, #4ecdc4 0%, #44a08d 100%);
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }
        .magic-button:hover {
            transform: translateY(-2px) scale(1.05);
            box-shadow: 0 20px 40px rgba(78, 205, 196, 0.4);
        }
    </style>
</head>
<body>
    <div id="app" class="min-h-screen py-8">
        <div class="max-w-4xl mx-auto px-4">
            <div class="payment-card p-8">
                <div class="text-center mb-8">
                    <h1 class="text-3xl font-bold text-gray-900 mb-2">üí≥ ÊîØ‰ªòËÆ¢Âçï</h1>
                    <p class="text-gray-600" v-text="orderNoText"></p>
                </div>
                
                <div class="grid grid-cols-1 lg:grid-cols-2 gap-8">
                    <!-- ËÆ¢Âçï‰ø°ÊÅØ -->
                    <div>
                        <h2 class="text-xl font-semibold text-gray-900 mb-4">ËÆ¢Âçï‰ø°ÊÅØ</h2>
                        <div class="space-y-4">
                            <div class="flex justify-between">
                                <span class="text-gray-600">ËÆ¢ÂçïÂè∑Ôºö</span>
                                <span class="font-semibold" v-text="orderNo"></span>
                            </div>
                            <div class="flex justify-between">
                                <span class="text-gray-600">Êï∞ÈáèÔºö</span>
                                <span class="font-semibold" v-text="quantityText"></span>
                            </div>
                            <div class="flex justify-between">
                                <span class="text-gray-600">Âçï‰ª∑Ôºö</span>
                                <span class="font-semibold" v-text="unitPriceText"></span>
                            </div>
                            <div class="flex justify-between text-lg font-bold border-t pt-4">
                                <span>ÊÄªËÆ°Ôºö</span>
                                <span class="text-blue-600" v-text="totalPriceText"></span>
                            </div>
                            <div v-if="couponInfo" class="flex justify-between text-sm text-green-600">
                                <span>Â∑≤‰ºòÊÉ†Ôºö</span>
                                <span v-text="discountText"></span>
                            </div>
                        </div>
                    </div>
                    
                    <!-- ÊîØ‰ªòÊñπÂºè -->
                    <div>
                        <h2 class="text-xl font-semibold text-gray-900 mb-4">ÊîØ‰ªòÊñπÂºè</h2>
                        
                        <!-- Âà∏Á†ÅÊîØ‰ªò -->
                        <div class="mb-6">
                            <label class="block text-sm font-medium text-gray-700 mb-2">
                                Âà∏Á†ÅÊîØ‰ªò
                            </label>
                            <div class="flex space-x-2">
                                <input 
                                    type="text" 
                                    v-model="couponCode"
                                    placeholder="ËØ∑ËæìÂÖ•Âà∏Á†Å"
                                    class="flex-1 px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                                >
                                <button 
                                    @click="validateCoupon"
                                    :disabled="!couponCode"
                                    class="px-6 py-3 bg-blue-500 text-white rounded-lg hover:bg-blue-600 disabled:opacity-50 disabled:cursor-not-allowed"
                                >
                                    È™åËØÅ
                                </button>
                            </div>
                            <div v-if="couponInfo" class="mt-2 p-4 bg-green-50 border border-green-200 rounded-lg">
                                <div class="flex items-center space-x-2 mb-2">
                                    <span class="text-green-800 font-medium">‚úÖ Âà∏Á†ÅÊúâÊïàÔºÅ</span>
                                </div>
                                <div class="space-y-1 text-sm">
                                    <div class="flex justify-between">
                                        <span class="text-gray-600">Âéü‰ª∑Ôºö</span>
                                        <span class="text-gray-800" v-text="originalAmountText"></span>
                                    </div>
                                    <div class="flex justify-between">
                                        <span class="text-green-600">ÊäòÊâ£Ôºö</span>
                                        <span class="text-green-600 font-semibold" v-text="discountAmountText"></span>
                                    </div>
                                    <div class="flex justify-between border-t pt-1">
                                        <span class="text-gray-800 font-medium">ÂÆû‰ªòÔºö</span>
                                        <span class="text-green-800 font-bold" v-text="finalAmountText"></span>
                                    </div>
                                </div>
                            </div>
                            <div v-if="couponError" class="mt-2 p-3 bg-red-50 border border-red-200 rounded-lg">
                                <p class="text-red-800" v-text="couponError"></p>
                            </div>
                        </div>
                        
                        <!-- ÊîØ‰ªòÊåâÈíÆ -->
                        <button 
                            @click="processPayment"
                            :disabled="isProcessing"
                            class="magic-button w-full py-4 rounded-lg text-white font-semibold text-lg shadow-lg disabled:opacity-50"
                        >
                            <span v-if="!isProcessing">üí≥ Á°ÆËÆ§ÊîØ‰ªò</span>
                            <span v-else>‚è≥ Â§ÑÁêÜ‰∏≠...</span>
                        </button>
                        
                        <div class="mt-4 text-center">
                            <a href="/design" class="text-blue-600 hover:text-blue-800 text-sm">
                                ‚Üê ËøîÂõûËÆæËÆ°È°µÈù¢
                            </a>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        const { createApp, ref, computed, onMounted } = Vue;
        
        createApp({
            setup() {
                const orderNo = ref('');
                const orderInfo = ref({});
                const couponCode = ref('');
                const couponInfo = ref(null);
                const couponError = ref('');
                const isProcessing = ref(false);
                
                const loadOrderInfo = async () => {
                    const urlParams = new URLSearchParams(window.location.search);
                    orderNo.value = urlParams.get('order_no') || '';
                    
                    if (orderNo.value) {
                        try {
                            const headers = {};
                            // Ê∑ªÂä†ËÆæÂ§áIDÂ§¥
                            if (window.DeviceManager && window.DeviceManager.getDeviceId()) {
                                headers['X-Device-ID'] = window.DeviceManager.getDeviceId();
                            }
                            
                            const response = await fetch(`/api/v1/orders/${orderNo.value}`, {
                                headers: headers
                            });
                            const result = await response.json();
                            
                            if (result.success) {
                                orderInfo.value = result.order;
                            } else {
                                alert('ËÆ¢Âçï‰∏çÂ≠òÂú®');
                                window.location.href = '/design';
                            }
                        } catch (error) {
                            console.error('Âä†ËΩΩËÆ¢Âçï‰ø°ÊÅØÂ§±Ë¥•:', error);
                            alert('Âä†ËΩΩËÆ¢Âçï‰ø°ÊÅØÂ§±Ë¥•');
                        }
                    }
                };
                
                const validateCoupon = async () => {
                    if (!couponCode.value) return;
                    
                    try {
                        // Ë∞ÉÁî®Âà∏Á†ÅÈ™åËØÅAPI
                        const headers = {
                            'Content-Type': 'application/json'
                        };
                        // Ê∑ªÂä†ËÆæÂ§áIDÂ§¥
                        if (window.DeviceManager && window.DeviceManager.getDeviceId()) {
                            headers['X-Device-ID'] = window.DeviceManager.getDeviceId();
                        }
                        
                        const response = await fetch('/api/v1/coupons/validate', {
                            method: 'POST',
                            headers: headers,
                            body: JSON.stringify({
                                code: couponCode.value,
                                order_amount: orderInfo.value.total_price
                            })
                        });
                        
                        const result = await response.json();
                        
                        if (result.success) {
                            couponInfo.value = {
                                code: couponCode.value,
                                discount: result.discount,
                                discountType: result.discount_type,
                                originalAmount: orderInfo.value.total_price,
                                finalAmount: orderInfo.value.total_price - result.discount
                            };
                            couponError.value = '';
                            
                            // Ëß¶ÂèëÊàêÂäüÊïàÊûú
                            if (window.MagicExperience) {
                                window.MagicExperience.showMagicNotification('Âà∏Á†ÅÈ™åËØÅÊàêÂäüÔºÅ', 'success', 2000);
                                window.MagicExperience.createParticles(
                                    window.innerWidth / 2,
                                    window.innerHeight / 2,
                                    10,
                                    'success'
                                );
                            }
                        } else {
                            couponError.value = result.error || 'Âà∏Á†ÅÊó†ÊïàÊàñÂ∑≤ËøáÊúü';
                            couponInfo.value = null;
                            
                            // Ëß¶ÂèëÈîôËØØÊïàÊûú
                            if (window.MagicExperience) {
                                window.MagicExperience.showMagicNotification('Âà∏Á†ÅÈ™åËØÅÂ§±Ë¥•', 'error', 2000);
                            }
                        }
                    } catch (error) {
                        console.error('È™åËØÅÂà∏Á†ÅÂ§±Ë¥•:', error);
                        couponError.value = 'È™åËØÅÂà∏Á†ÅÂ§±Ë¥•ÔºåËØ∑ÈáçËØï';
                        couponInfo.value = null;
                        
                        if (window.MagicExperience) {
                            window.MagicExperience.showMagicNotification('ÁΩëÁªúÈîôËØØÔºåËØ∑ÈáçËØï', 'error', 2000);
                        }
                    }
                };
                
                const processPayment = async () => {
                    isProcessing.value = true;
                    
                    try {
                        // È™åËØÅ‰ºòÊÉ†Âà∏ÊîØ‰ªòÊñπÂºè
                        if (!couponCode.value || couponCode.value.trim() === '') {
                            const errorMsg = '‰ΩøÁî®‰ºòÊÉ†Âà∏ÊîØ‰ªòÂøÖÈ°ªËæìÂÖ•Âà∏Á†Å';
                            console.log('ÊîØ‰ªòÈ™åËØÅÂ§±Ë¥•:', errorMsg);
                            alert(errorMsg); // Áõ¥Êé•‰ΩøÁî®alertÁ°Æ‰øùÊòæÁ§∫
                            isProcessing.value = false;
                            return;
                        }
                        
                        // È™åËØÅ‰ºòÊÉ†Âà∏‰ø°ÊÅØ
                        if (!couponInfo.value) {
                            const errorMsg = 'ËØ∑ÂÖàÈ™åËØÅÂà∏Á†ÅÊúâÊïàÊÄß';
                            console.log('ÊîØ‰ªòÈ™åËØÅÂ§±Ë¥•:', errorMsg);
                            alert(errorMsg); // Áõ¥Êé•‰ΩøÁî®alertÁ°Æ‰øùÊòæÁ§∫
                            isProcessing.value = false;
                            return;
                        }
                        
                        const paymentData = {
                            order_no: orderNo.value,
                            payment_method: 'coupon',
                            coupon_code: couponCode.value || null
                        };
                        
                        const headers = {
                            'Content-Type': 'application/json'
                        };
                        // Ê∑ªÂä†ËÆæÂ§áIDÂ§¥
                        if (window.DeviceManager && window.DeviceManager.getDeviceId()) {
                            headers['X-Device-ID'] = window.DeviceManager.getDeviceId();
                        }
                        
                        const response = await fetch('/api/v1/payment', {
                            method: 'POST',
                            headers: headers,
                            body: JSON.stringify(paymentData)
                        });
                        
                        const result = await response.json();
                        
                        if (result.success) {
                            // Ëß¶ÂèëÊîØ‰ªòÊàêÂäüÊïàÊûú
                            if (window.MagicExperience) {
                                window.MagicExperience.showSuccessCelebration('üéâ');
                                window.MagicExperience.createConfetti();
                                window.MagicExperience.showMagicNotification('ÊîØ‰ªòÊàêÂäüÔºÅÊ≠£Âú®Ë∑≥ËΩ¨...', 'success', 2000);
                            }
                            
                            // Êõ¥Êñ∞Áî®Êà∑Áä∂ÊÄÅ
                            if (window.UserStateManager) {
                                window.UserStateManager.addOrderHistory(result.order);
                            }
                            
                            // Âª∂ËøüË∑≥ËΩ¨ÔºåËÆ©Áî®Êà∑ÁúãÂà∞Â∫ÜÁ•ùÊïàÊûú
                            setTimeout(() => {
                                window.location.href = `/order/${orderNo.value}`;
                            }, 2000);
                        } else {
                            const errorMsg = result.error || 'ÊîØ‰ªòÂ§±Ë¥•';
                            console.log('ÊîØ‰ªòAPIËøîÂõûÈîôËØØ:', result);
                            alert(errorMsg); // Áõ¥Êé•‰ΩøÁî®alertÁ°Æ‰øùÊòæÁ§∫
                        }
                    } catch (error) {
                        console.error('ÊîØ‰ªòÂ§ÑÁêÜÂ§±Ë¥•:', error);
                        const errorMsg = 'ÊîØ‰ªòÂ§ÑÁêÜÂ§±Ë¥•ÔºåËØ∑ÈáçËØï';
                        alert(errorMsg); // Áõ¥Êé•‰ΩøÁî®alertÁ°Æ‰øùÊòæÁ§∫
                    } finally {
                        isProcessing.value = false;
                    }
                };
                
                onMounted(() => {
                    loadOrderInfo();
                    
                    // ÂàùÂßãÂåñMagic ExperienceÁ≥ªÁªü
                    if (window.MagicExperience) {
                        console.log('‚ú® ÊîØ‰ªòÈ°µÈù¢ Magic Experience Á≥ªÁªüÂ∑≤Â∞±Áª™');
                        
                        // ‰∏∫ÊåâÈíÆÊ∑ªÂä†È≠îÊ≥ïÊïàÊûú
                        setTimeout(() => {
                            document.querySelectorAll('button').forEach(btn => {
                                window.MagicExperience.addMagicButtonEffect(btn);
                            });
                        }, 100);
                        
                        // ÊòæÁ§∫Ê¨¢ËøéÊ∂àÊÅØ
                        setTimeout(() => {
                            window.MagicExperience.showMagicNotification('Ê¨¢ËøéÊù•Âà∞ÊîØ‰ªòÈ°µÈù¢ÔºÅ', 'success', 3000);
                        }, 1000);
                    }
                });
                
                // ËÆ°ÁÆóÂ±ûÊÄß
                const orderNoText = computed(() => `ËÆ¢ÂçïÂè∑Ôºö${orderNo.value}`);
                const quantityText = computed(() => `${orderInfo.value.quantity || 1} ‰∏™`);
                const unitPriceText = computed(() => `¬•${orderInfo.value.unit_price || 15.00}`);
                const totalPriceText = computed(() => {
                    const amount = couponInfo.value ? couponInfo.value.finalAmount : (orderInfo.value.total_price || 15.00);
                    return `¬•${amount}`;
                });
                const discountText = computed(() => `-¬•${couponInfo.value?.discount || 0}`);
                const originalAmountText = computed(() => `¬•${couponInfo.value?.originalAmount || 0}`);
                const discountAmountText = computed(() => `-¬•${couponInfo.value?.discount || 0}`);
                const finalAmountText = computed(() => `¬•${couponInfo.value?.finalAmount || 0}`);
                
                return {
                    orderNo,
                    orderInfo,
                    couponCode,
                    couponInfo,
                    couponError,
                    isProcessing,
                    validateCoupon,
                    processPayment,
                    orderNoText,
                    quantityText,
                    unitPriceText,
                    totalPriceText,
                    discountText,
                    originalAmountText,
                    discountAmountText,
                    finalAmountText
                };
            }
        }).mount('#app');
    </script>
</body>
</html>
